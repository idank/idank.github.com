<!doctype html>
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
    <meta charset="utf-8">
  <link href='http://fonts.googleapis.com/css?family=Cantarell' rel='stylesheet' type='text/css'>
  <meta http-equiv="X-UA-Compatible" content="">
  <title>the filecache decorator - aleph.nu</title>
  <meta name="description" content="">
  <meta name="author" content="Idan Kamara">

    <link rel="shortcut icon" href="/favicon.png">
  
    <link rel="stylesheet" href="/media/css/site.css">
  
  
    <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-28052058-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
  
    </head>
<body id="filecache-decorator">
  <div id="container">
            <div id="header">
          <img src="/media/images/aleph.png" height="120"/>
                      <ul id="navigation">
                          <li>
                <a title="Home Page" class="" href="/">
                    Home
                </a>
              </li>              <li>
                <a title="University" class="" href="/university.html">
                    University
                </a>
              </li>              <li>
                <a title="About" class="" href="/about.html">
                    About
                </a>
              </li>            </ul>          <div><h2 id="site-title"><span>Aleph.Nu</span><span id="title-suffix">ll</span></h2></div>
      </div> <!--! end of #header -->
                  <div class="content">
          <div class="title">
                <h2>the filecache decorator</h2>
    
    <ul class="footer">
            <li class="tags">
            <ul>
                            <li>
                    <a class="small" href="/blog/tags/gsoc.html">gsoc</a>
                </li>
                            <li>
                    <a class="small" href="/blog/tags/mercurial.html">mercurial</a>
                </li>
                        </ul>
        </li>
                    <li class="date"><abbr class="timeago" title="2011-06-04 11:37:00">04 Jun 2011</abbr>, 04 Jun 2011
</li>
    </ul>
</div>

<p>The past week or so I&#8217;ve been working on <a href="http://markmail.org/thread/uublw3vjjrmqp5nr">a new decorator</a> that tracks files under the .hg/ directory for&nbsp;changes.</p>
<p>In short, you use it on a method and it turns it to a property with caching the result, like <a href="http://selenic.com/repo/hg/file/6d1d0b9c4ecc/mercurial/util.py#l164">propertycache</a>. But it also gives you the ability to invalidate the cached property, which triggers a stat(2) call that checks if the file behind the property changed since the last time it was&nbsp;read.</p>
<p>I used it on the dirstate, changelog, manifest, bookmark files, and the tags cache in localrepo so far. What it means in practice is that a call to repo.invalidate() is significantly cheaper where some of the above haven&#8217;t changed since the last time they were&nbsp;read.</p>
<p>This is crucial so the command server&#8217;s cached repository stays up-to-date where it changes by a different process than the server itself, i.e. via committing to it directly on the command&nbsp;line.</p>
<p>The main issue with this approach is that we fail if we end up missing changes. For example, a filesystem that doesn&#8217;t have subsecond precision, will cause our cache to lie in the following&nbsp;situation:</p>
<table style="td: padding-right: 5px;">
<tr><td>time<td>action</tr>
<tr><td>0<td>file x is modified</tr>
<tr><td>0.1<td>file x is read, inserted to the cache</tr>
<tr><td>0.2<td>file x is modified again, size remains the same</tr>
</table>

<p>We end up with file x from 0 in our cache. Now suppose we invalidate the cache, this triggers a stat(&#8216;x&#8217;), in which st_mtime == 0, which according to our cache is the most recent version of x, hence no need to reread. But it was in fact modified afterwards, but our filesystem doesn&#8217;t have the necessary precision to help us spot&nbsp;it.</p>
<p>So we have to make sure our cache is reliable, and if we can&#8217;t, we must fallback to reading the file every time the cache is&nbsp;invalidated.</p>
<p>Luckily Mercurial&#8217;s approach to writing files helps us here. Essentially most of the important files under .hg/ are either: 1) atomically replaced, 2)&nbsp;appended.</p>
<p>If our filesystem is able to tell us a) if a file is replaced, or b) if it has subsecond precision, we&#8217;re basically good to go. Because if we have (a) then (1) is covered, and (2) is covered because st_size changes on append. And if we have (b) it&#8217;s&nbsp;obvious.</p>
<p>The current plan is to use the above test to make sure our cache is reliable, otherwise read the file every time. In the future we can improve this by also noting <strong>when</strong> the file was&nbsp;read.</p>
<div id="disqus_thread"></div>

<script type="text/javascript">
    var disqus_shortname = 'alephnull1'; // required: replace example with your forum shortname

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

<p><a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a></p>      </div>
      </div> <!--! end of #container -->
  <div id="footer">
  </div>
      <script src="//ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.js"></script>
  <script>window.jQuery || document.write('<script src="/media/js/libs/jquery-1.5.1.min.js">\x3C/script>')</script>
  <script src="/media/js/libs/jquery.timeago.js" type="text/javascript"></script>
  <script>
      jQuery(document).ready(function() {
        jQuery("abbr.timeago").timeago();
      });
  </script>
    <script src="/media/js/libs/highlight.pack.js" type="text/javascript"></script>
<script type="text/javascript">
        hljs.initHighlightingOnLoad();
</script>
  </body>
</html>